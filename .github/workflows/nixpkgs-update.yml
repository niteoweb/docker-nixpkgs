name: Nixpkgs update
on:
  schedule:
    # Every hour
    - cron: '0 * * * *'

  # Allow triggering manually
  workflow_dispatch:

jobs:
  update:
    name: Update all nixpkgs sources
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2.3.2
      with:
        # Apparently we need to use a separate GITHUB_TOKEN (not the
        # autogenerated one available during each workflow) if we want the push
        # to trigger another workflow
        persist-credentials: false
    - uses: cachix/install-nix-action@v10
      with:
        skip_adding_nixpkgs_channel: true
    - name: Building updater
      run: nix-build -A nixpkgs-updater
    - name: Running updater
      run: result/bin/update
    - name: Commit updates
      run: |
        git status
        if ! git diff-files; then
          echo "Changes detected, committing them"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Automatic niv update" -a
        else
          echo "No changes detected"
        fi
    - name: Push changes
      uses: ad-m/github-push-action@v0.6.0
      with:
        github_token: ${{ secrets.UPDATE_GITHUB_TOKEN }}
